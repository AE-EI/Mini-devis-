<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#101217">
  <title>MiniDevis — MVP</title>
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root { --pad:14px; --radius:14px; --gap:10px; --font: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; }
    * { box-sizing:border-box; }
    html,body { height:100%; margin:0; background:#101217; color:#e8e8ea; font-family:var(--font); }
    .app { max-width:560px; margin:0 auto; padding:16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    h1 { font-size:20px; margin:0; font-weight:700; letter-spacing:.2px; }
    .card { background:#171a21; border:1px solid #232838; border-radius:14px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.18); }
    .stack { display:flex; flex-direction:column; gap:10px; }
    .row { display:flex; gap:10px; }
    .grid { display:grid; grid-template-columns: repeat(2,1fr); gap:10px; }
    button,.btn{display:block;width:100%;border:1px solid #2a3145;background:#1d2230;color:#eef;padding:14px 16px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;text-align:center}
    button:hover{background:#21283a}
    .btn-ghost{background:transparent;border:1px dashed #2a3145;color:#cbd2f6}
    .btn-primary{background:#2a6df4;border-color:#2a6df4;color:#fff}
    .btn-primary:hover{filter:brightness(1.05)}
    label{font-size:14px;color:#c9cbd3}
    input[type="text"],input[type="number"],textarea{width:100%;background:#121620;border:1px solid #2a3145;color:#e9ecff;padding:12px;border-radius:10px;font-size:16px}
    textarea{min-height:96px;resize:vertical}
    .footer{display:flex;gap:10px;position:sticky;bottom:0;margin-top:12px}
    .muted{color:#9aa0b8;font-size:13px}
    .hidden{display:none!important}
    .title{font-size:16px;font-weight:700}
    .summary{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e1016;border:1px solid #2a3145;padding:12px;border-radius:10px}
    .breadcrumb{color:#9aa0b8;font-size:13px;margin-bottom:8px}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>MiniDevis</h1>
    <div class="top-actions">
      <button id="seeEstimate" class="btn">Voir l’estimatif</button>
      <button id="resetAll" class="btn btn-ghost" title="Réinitialiser">Nouveau</button>
    </div>
  </header>

  <!-- Écran 1 -->
  <section id="screen-start" class="card stack">
    <div class="breadcrumb">Étape 1 · Pièce</div>
    <div class="title">Choisir une pièce</div>
    <div class="grid">
      <button class="btn" data-room="Cuisine">Cuisine</button>
      <button class="btn" data-room="Chambre">Chambre</button>
    </div>
    <div>
      <label for="roomDetail">Précision (ex. “Cuisine RDC”, “Chambre 2”)</label>
      <input id="roomDetail" type="text" placeholder="(optionnel)" />
    </div>
    <div class="footer">
      <button id="startNext" class="btn-primary">Continuer</button>
    </div>
  </section>

  <!-- Écran 2 -->
  <section id="screen-category" class="card stack hidden">
    <div class="breadcrumb">Étape 2 · Catégorie</div>
    <div class="title">Dans <span id="roomChosenLabel"></span>, tu veux ajouter…</div>
    <div class="grid">
      <button class="btn" data-cat="Prises">Prises</button>
      <button class="btn" data-cat="Éclairage">Éclairage</button>
    </div>
    <div class="footer">
      <button class="btn" id="backToStart">Retour</button>
    </div>
  </section>

  <!-- Écran 3 -->
  <section id="screen-pose" class="card stack hidden">
    <div class="breadcrumb">Étape 3 · Type de pose</div>
    <div class="title">Type de pose</div>
    <div class="grid">
      <button class="btn" data-pose="encastrée maçonnerie">Encastrée maçonnerie</button>
      <button class="btn" data-pose="apparent">Apparent</button>
    </div>
    <div class="footer">
      <button class="btn" id="backToCategory">Retour</button>
    </div>
  </section>

  <!-- Écran 4A (prises) -->
  <section id="screen-qty-prises" class="card stack hidden">
    <div class="breadcrumb">Étape 4 · Quantités</div>
    <div class="title">Combien de prises 2P+T&nbsp;?</div>
    <label>Quantité</label>
    <input id="qtyPrises" type="number" min="0" step="1" value="0" />
    <div class="footer">
      <button class="btn" id="backToPoseFromPrises">Retour</button>
      <button class="btn btn-primary" id="toNotesFromPrises">Continuer</button>
    </div>
  </section>

  <!-- Écran 4B (éclairage) -->
  <section id="screen-qty-eclairage" class="card stack hidden">
    <div class="breadcrumb">Étape 4 · Quantités</div>
    <div class="title">Éclairage — quantités</div>
    <div class="grid">
      <div class="stack">
        <label>Points lumineux</label>
        <input id="qtyPoints" type="number" min="0" step="1" value="0" />
      </div>
      <div class="stack">
        <label>Interrupteurs simples</label>
        <input id="qtyInterSimple" type="number" min="0" step="1" value="0" />
      </div>
      <div class="stack">
        <label>Interrupteurs doubles</label>
        <input id="qtyInterDouble" type="number" min="0" step="1" value="0" />
      </div>
    </div>
    <div class="footer">
      <button class="btn" id="backToPoseFromEcl">Retour</button>
      <button class="btn btn-primary" id="toNotesFromEcl">Continuer</button>
    </div>
  </section>

  <!-- Écran 5 (note) -->
  <section id="screen-notes" class="card stack hidden">
    <div class="breadcrumb">Étape 5 · Note</div>
    <div class="title">Ajouter une note (optionnel)</div>
    <textarea id="noteField" placeholder="(ex. ‘saignée mur porteur → prévoir goulotte’)"></textarea>
    <div class="footer">
      <button class="btn" id="skipNote">Passer</button>
      <button class="btn btn-primary" id="saveEntry">Enregistrer</button>
    </div>
  </section>

  <!-- Estimatif -->
  <section id="screen-estimate" class="card stack hidden">
    <div class="breadcrumb">Estimatif</div>
    <div class="title">Récapitulatif</div>
    <div id="estimateContainer" class="summary"></div>
    <div class="row">
      <button class="btn" id="exportTxt">Exporter .txt</button>
      <button class="btn btn-ghost" id="closeEstimate">Fermer</button>
    </div>
    <div class="muted">Les prix unitaires sont par défaut (modifiable dans <code>unitPrices</code>).</div>
  </section>

  <p class="muted" id="info">Astuce : après ouverture, “Partager → Ajouter à l’écran d’accueil”.</p>
</div>

<script>
// Service worker (offline)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}
</script>

<script>
(function() {
  const state = { entries: [], current: { roomType:null, roomDetail:"", roomName:null, category:null, pose:null, q:{} } };

  const unitPrices = {
    prises: { "encastrée maçonnerie": 120, "apparent": 100 },
    eclairage: {
      pointLum:    { "encastrée maçonnerie": 80, "apparent": 70 },
      interSimple: { "encastrée maçonnerie": 40, "apparent": 35 },
      interDouble: { "encastrée maçonnerie": 55, "apparent": 50 }
    }
  };

  const $ = s => document.querySelector(s);
  const show = id => $(id).classList.remove("hidden");
  const hide = id => $(id).classList.add("hidden");
  const goto = ids => {
    ["#screen-start","#screen-category","#screen-pose","#screen-qty-prises","#screen-qty-eclairage","#screen-notes","#screen-estimate"]
      .forEach(hide);
    ids.forEach(show);
  };

  const screenStart = $("#screen-start");
  const roomDetail = $("#roomDetail");
  const roomChosenLabel = $("#roomChosenLabel");

  const qtyPrises = $("#qtyPrises");
  const qtyPoints = $("#qtyPoints");
  const qtyInterSimple = $("#qtyInterSimple");
  const qtyInterDouble = $("#qtyInterDouble");

  const noteField = $("#noteField");
  const estimateContainer = $("#estimateContainer");

  // Start
  screenStart.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-room]");
    if (!btn) return;
    state.current.roomType = btn.dataset.room;
    [...screenStart.querySelectorAll("button[data-room]")].forEach(b => b.classList.remove("btn-primary"));
    btn.classList.add("btn-primary");
  });

  document.getElementById("startNext").addEventListener("click", () => {
    const rt = state.current.roomType;
    if (!rt) return alert("Choisis une pièce (Cuisine ou Chambre).");
    const detail = (roomDetail.value || "").trim();
    state.current.roomDetail = detail;
    state.current.roomName = detail ? `${rt} — ${detail}` : rt;
    roomChosenLabel.textContent = state.current.roomName;
    goto(["#screen-category"]);
  });

  // Category
  document.getElementById("backToStart").addEventListener("click", () => goto(["#screen-start"]));
  document.getElementById("screen-category").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-cat]");
    if (!btn) return;
    state.current.category = btn.dataset.cat;
    goto(["#screen-pose"]);
  });

  // Pose
  document.getElementById("backToCategory").addEventListener("click", () => goto(["#screen-category"]));
  document.getElementById("screen-pose").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-pose]");
    if (!btn) return;
    state.current.pose = btn.dataset.pose;
    if (state.current.category === "Prises") {
      qtyPrises.value = 0; goto(["#screen-qty-prises"]);
    } else {
      qtyPoints.value = 0; qtyInterSimple.value = 0; qtyInterDouble.value = 0;
      goto(["#screen-qty-eclairage"]);
    }
  });

  // Quantités — prises
  document.getElementById("backToPoseFromPrises").addEventListener("click", () => goto(["#screen-pose"]));
  document.getElementById("toNotesFromPrises").addEventListener("click", () => {
    const q = parseInt(qtyPrises.value || "0", 10);
    state.current.q = { prises: Math.max(0, q) };
    goto(["#screen-notes"]);
  });

  // Quantités — éclairage
  document.getElementById("backToPoseFromEcl").addEventListener("click", () => goto(["#screen-pose"]));
  document.getElementById("toNotesFromEcl").addEventListener("click", () => {
    const qpl = parseInt(qtyPoints.value||"0",10);
    const qis = parseInt(qtyInterSimple.value||"0",10);
    const qid = parseInt(qtyInterDouble.value||"0",10);
    state.current.q = { pointLum:Math.max(0,qpl), interSimple:Math.max(0,qis), interDouble:Math.max(0,qid) };
    goto(["#screen-notes"]);
  });

 
